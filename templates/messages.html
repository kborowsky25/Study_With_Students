{% extends "template.html" %}

{% block body %}
    <div class="navbar_hub">
        <div class="navbar_hub_container">
            <div class="back_to_hub">
                <span class="material-symbols-outlined"> hub </span>
                <a href="/hub-student"> Back to Hub</a>
            </div>
            <div class="logo"> <span class="material-symbols-outlined"> rocket_launch
                </span><a href="/"> Study with Students</a></div>
            <ul class="elements_container_signup">
                <li>
                    <a href="/hub-tutor" id="switch_button">Switch Mode Tutor</a>
                </li>
            </ul>

        </div>
    </div>

    <div class="inbox">
        <div class="inbox_container">
            <h class="inbox_h">Inbox</h>
            <hr>
        </div>
    </div>

    <div class="container">
        <!-- Left sidebar with sender IDs -->
        <div class="sidebar">
            <h2 class="senders_h">Senders</h2>
            <ul id="sender-list">
                {% for receiver_id, sender_messages in grouped_messages.items() %}
                    <button class="sender-box" data-sender-id="{{ receiver_id }}">
                        Sender {{ sender_messages[-1][-1] }}
                    </button>
                {% endfor %}
            </ul>
        </div>

        <!-- Right section with messages -->
        <div class="messages">
            <h2 class="messages_h">Messages</h2>
            <div id="message-area">
                <p style="color: white">Select a sender to view their messages.</p>
            </div>
        </div>
    </div>

    <script>
        // Add event listener to each sender box in the sidebar
        document.querySelectorAll('.sender-box').forEach((senderBox) => {
            senderBox.addEventListener('click', function(event) {
                const senderId = event.target.dataset.senderId;  // Get the sender_id from the clicked box
                fetchMessages(senderId); // Fetch messages for this sender
            });
        });

        // Function to fetch messages for a sender
        function fetchMessages(receiverId) {
            fetch("/messages", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ receiver_id: receiverId })
            })
            .then(response => response.json())
            .then(data => {
                const messageArea = document.getElementById('message-area');
                messageArea.innerHTML = '';  // Clear previous messages

                if (data.messages.length === 0) {
                    messageArea.innerHTML = '<p style="color: white">No messages found for this sender.</p>';
                } else {
                    data.messages.forEach((message) => {
                        const messageDiv = document.createElement('div');
                        messageDiv.classList.add('message');
                        messageDiv.innerHTML = `
                           <div style="color: white;">
                                <p>${message[3]}</p> 
                                
                                <small style="margin-left: 30vw">${message[4]}</small>
                            </div>
                        `;
                        messageArea.appendChild(messageDiv);
                    });
                }
            })
            .catch(error => {
                console.error('Error fetching messages:', error);
            });
        }
    </script>
{% endblock %}
